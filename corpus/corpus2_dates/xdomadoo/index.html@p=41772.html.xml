<document>
	<date>2014-10-15</date>
        <title>Accder depuis lextrieur  Jeedom en Https</title>
        <author> Laurent </author>
        <tags_set>
                <tag>acces distant</tag>
                <tag>guide</tag>
                <tag>https</tag>
                <tag>jeedom</tag>
                <tag>tuto</tag>
        </tags_set>
        <categories_set>
                <category>Guide Domotique Jeedom</category>
        </categories_set>
        <text>
                                                         Pour faire un site web en  Http http Pour generer un certificat, il faut posseder son propre nom de domaine (DNS) quil est possible dacheter sur differents site comme Gandi, OVH,  pour un prix denviron 10 H.T. par an. Remarque :  Un nom de domaine dynamique (dyndns, no-ip, ) ne peut pas etre utilise car vous devez etre proprietaire du nom de domaine racine (ex: chezmoi.fr). Connaissance necessaire: se connecter en ssh sur le serveur  JEEDOM Le probleme dun certificat auto-signe cest que certains navigateurs (Pour des raisons de securite) refusent toutes connexions a des sites en  Http Nous allons voir comment generer ces certificats et vous pourrez choisir lune ou lautre de ces solutions. Pour ce tuto, non admettrons que le nom de domaine que nous avons achete sappelle chezmoi.fr. 1.  Http Pour generer un certificat auto-signe, connectez-vous en ssh sur le serveur  JEEDOM $ sudo mkdir /etc/nginx/ssl $ cd /etc/nginx/ssl $ sudo openssl req -x509 -nodes -days 1095 -newkey rsa:4096 -keyout  jeedom .key -out  jeedom .crt La derniere commande va creer un certificat avec une cle de chiffrement de 4096 bits et qui sera valide pendant 1095 jours. Afin de le creer, quelques informations vont vous etre demandees(Vous pouvez mettre ce que vous voulez sauf dans la partie Common Name ou il faut absolument donner le nom de domaine pour lequel vous allez utiliser le certificat) : Country Name : Le code du pays sur 2 lettres. (Ex: FR) State or Province Name: Le nom de votre departement. Locality Name: Le nom de votre ville. Organization Name: Le nom de votre societe. (Ex:  Jeedom Common Name: Votre nom de domaine. (Ex:  jeedom Email Address: Votre adresse mail. Une fois le certificat genere, on protege la cle privee: $ sudo chmod 400  jeedom .key Et on modifie le fichier de configuration de nginx (le serveur web) afin que le serveur  JEEDOM http Http $ sudo vi /etc/nginx/sites-enabled/default Ajouter les lignes suivantes, entre les lignes server { et root /usr/share/nginx/www; : listen 80; listen 443 ssl; ssl_certificate /etc/nginx/ssl/  jeedom ssl_certificate_key /etc/nginx/ssl/  jeedom ssl_session_timeout 5m; Enfin on redemarre nginx: $ sudo service nginx restart Cest fini pour le certificat, il ne reste plus qua bien configurer votre nom de domaine chezmoi.fr et le sous-domaine jeedom.chezmoi.fr ainsi que la redirection de port sur votre box afin dacceder a votre box JEEDOM de lexterieur en  Http Remarque :  Avec cette configuration de nginx, JEEDOMest toujours accessible en  http 2.  Http a. Sinscrire sur StartSSL Il existepas mal de site sur lequel acheter un certificat emis par une autorite de certification (Ex: Gandi a partir de 12 pour 1 adresse pour 1 an). Mais par le biais du site StartSSL, il est possible de generer un certificat de confiance gratuit pour un domaine et un sous-domain. Ce qui nous suffit largement pour securiser lacces a jeedom. Afin de generer le certificat, rendez-vous sur le site  https://www.startssl.com Cliquer sur Express Lane. Ensuite remplissez le formulaire qui permet de connaitre la personne physique a qui sera delivre le certificat (Le remplir avec des informations valides). Un email de confirmation vous est envoye sur ladresse mail renseignee avec un code de validation. Renseignez ce code dans la page qui sest affichee. (Attention a ne pas fermer la page avant.) Une fois ladresse mail validee, il peut se passer deux cas de figure: Soit startssl genere de suite un certificat client qui vous servira a vous authentifier sur leur site et il vous proposera de linstaller dans votre navigateur. Soit il vous faudra attendre (Que linscription soit validee) la reception dun mail (StartSSL Account Request) contenant un lien et un code de verification. Suivez ce lien et entrer le code de verification afin de pouvoir installer le certificat client dans votre navigateur. Cliquer sur Install. Remarque :  Une fois le certificat installe dans le navigateur, il faut absolument le sauvegarder, car si vous le perdez, vous ne pourrez plus acceder a votre compte sur startssl. En effet lauthentification sur startssl ne fonctionne pas comme dhabitude avec identifiant/mot de passe, mais utilise ce certificat client. Pour cela chercher une procedure correspondant a votre navigateur pour exporter un certificat, le certificat doit se trouver dans le magasin personnel avec comme nom StartCom Ltd.. b. Valider le nom de domaine Apres linstallation du certificat client, on va valider le nom de domaine que lon souhaite utiliser. Dans longlet Validations Wizard, choisir le type de validation Domain Name Validation Puis il faut fournir le nom de domaine que lon souhaite valider. Il sagit pour le moment du domaine racine. (Ex: chezmoi.fr) Ensuite nous devons fournir un nom de sous-domaine. (Ex: jeedom.chezmoi.fr) Il est ensuite demande de choisir une adresse mail qui servira a la validation. Normalement, celle que vous avez fourni a linscription devrait y etre, sinon choisissez-en une qui va bien. Cette adresse mail doit etre valide et vous devez y avoir acces car un code de validation va y etre envoye. Vous devez recevoir un code de validation sur lemail precedemment selectionne, quil faut rentrer dans lecran suivant. c. Generation du certificat de confiance Nous allons maintenant pouvoir generer notre certificat de confiance. Dans longlet Certificates Wizard selectionner le type de certificat cibleWeb Server SSL/TLS Certificate. La premiere etape consiste a creer une cle privee qui servira a chiffrer les echanges. Elle sera protegee par un mot de passe afin de ne pas etre utilisable par quelquun ne connaissant pas le mot de passe. Dans le formulaire, saisir le mot de passe que vous voulez pour proteger la cle privee (Un mot de passe assez long et complique est recommande) choisir la taille de la cle (Ici, pour avoir un securite correcte, nous choisirons 4096 bits). La cle privee est ensuite affichee dans un bloc texte. Elle commence par BEGIN RSA PRIVATE KEY  et finit par END RSA PRIVATE KEY . Copier tout le contenu (Y compris le BEGIN et le END dans un fichier texte (notepad ou autre, pas word) et sauvegarder ce fichier texte avec un nom jeedom.chezmoi.fr.key par exemple. Ce fichier est tres important et doit etre sauvegarde et securise comme le certificat client! Il faut ensuite choisir le nom de domaine pour lequel on veut generer le certificat (Celui que lon a valide precedemment). Un resume de ce qui va etre fait est affiche. Apres avoir clique sur Continue, il faudra patienter afin que le certificat soit genere. Un mail sur ladresse fournie pour la validation du nom de domaine sera envoye lorsque le certificat sera pret. Une fois ce mail recu, aller dans longlet Tool Box de votre profil et choisir Retrieve Certificate dans le menu (Remarquer au passage la date de fin de validite du certificat). Apres avoir clique sur Continue un bloc texte affiche le certificat. Copier tout le contenu (Y compris le BEGIN et le END dans un fichier texte (notepad ou autre, pas word) et sauvegarder ce fichier texte avec un nom jeedom.chezmoi.fr.crt par exemple. d. Installation du certificat de confiance Maintenant nous allons mettre en place tout ca sur le serveur Jeedom. Connectez-vous en ssh sur le serveur Jeedom et creer un repertoire pour mettre les certificats: $ sudo mkdir /etc/nginx/ssl Copier les fichiers cles et certificats (jeedom.chezmoi.fr.key et jeedom.chezmoi.fr.crt) dans le dossier /etc/nginx/ssl a laide de WinScp (Windows) ou autre. Ensuite nous allons decrypter et securiser le fichier qui contient la cle, car sinon nginx demandera le mot de passe de la cle a chaque demarrage: $ /etc/nginx/ssl $ sudo openssl rsa -in jeedom.chezmoi.fr.key -out jeedom.chezmoi.fr.key $ sudo chmod 400 jeedom.chezmoi.fr.key Puis nous allons ajouter a notre certificat les certificats de lautorite de certification: $ wget  http $ wget  http $ sudo bash -c cat jeedom.chezmoi.fr.crt sub.class1.server.ca.pem ca.pem  /etc/nginx/ssl/ jeedom.chezmoi.fr -chained.crt Et enfin nous allons modifier le fichier de configuration de nginx (le serveur web) afin que le serveur Jeedom accepte les connexions en  http Http $ sudo vi /etc/nginx/sites-enabled/default Ajouter les lignes suivantes, entre les lignes server { et root /usr/share/nginx/www; : listen 80; listen 443 ssl; ssl_certificate /etc/nginx/ssl/ jeedom.chezmoi.fr.crt; ssl_certificate_key /etc/nginx/ssl/ jeedom.chezmoi.fr.key; ssl_session_timeout 5m; Enfin on redemarre nginx: $ sudo service nginx restart Cest fini pour le certificat, il ne reste plus qua bien configurer votre nom de domaine chezmoi.fr et le sous-domaine jeedom.chezmoi.fr ainsi que la redirection de port sur votre box afin dacceder a Jeedom de lexterieur en  Http Remarque :  Avec cette configuration de nginx,Jeedom est toujours accessible en  http Gestion du nom de domaine  redirection Sur linterface dadministration du site ou vous avez achetez votre nom de domaine, vous devez pouvoir creer des entrees dns pour des sous-domaines de votre domaine principal. Il mest impossible de documenter cela car cela depend du site que vous avez choisi. Chez mon fournisseur, il faut aller dans linterface dadministration selectionner dans le menu  Hebergement: Entrees DNS Type A www.mon-ip.com Pour la redirection de port sur votre box internet, la non plus je ne peux pas documenter car cela depend de loperateur et de la box que vous avez ainsi que de la configuration de votre reseau local. Mais en gros il faut ouvrir le traffic entrant sur le port 443 vers le serveur Jeedom. Cest en general dans la section Redirection de port, choisir comme IP sources: Toutes, comme port source: 443, comme IP de destination: LIP de votre serveur Jeedom sur le reseau local, comme port de destination: 443. Remarque :  Pour plus de securite, vous pouvez faire une redirection a partir dun port non standard (superieur a 1024 par exemple 5151). Il faut donc mettre en port source dans la redirection de la box 5151, et on accede donc a Jeedom de lexterieur en saisissant ladresse:  http Merci a 1110 de touteladomotique.com pour son tuto qui a servi de base a celui-ci. Un grand merci a Sshafi, beta testeur deJEEDOM, pour cet article.  Simple Share Buttons Adder (5.6) simplesharebuttons.com  
 Ces sujets pourraient vous interesser aussi: 
 
 Jeedom  Guide dutilisation du capteur de temperature NodOn EnOcean 
 Jeedom  Guide dutilisation de lampoule connectee ZIPATO RGBW END .entry-content  
        </text>
</document>
