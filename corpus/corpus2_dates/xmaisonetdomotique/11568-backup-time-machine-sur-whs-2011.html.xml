<document>
	<date>2012-10-15</date>
        <title>
Backup Time Machine sur WHS 2011</title>
        <author>Cdric Locqueneux</author>
        <tags_set>
                <tag>Le monde MAC</tag>
                <tag>Time Machine</tag>
                <tag>WHS 2011</tag>
        </tags_set>
        <categories_set>
                <category>Guides Informatiques</category>
        </categories_set>
        <text>Une fonctionnalite tres interessante de Windows Home Server est la possibilite de sauvegarder automatiquement les ordinateurs de la maison. On installe sur chaque ordinateur un petit client, et a lheure programmee, WHS soccupe de faire les sauvegardes. Cest tres securisant, dautant plus que WHS est capable de restaurer completement un ordinateur plante. Malheureusement, meme si ce client existe pour Mac, la fonction backup nest pas implementee. Cest dommage, carcela etait possible via une petite bidouille sur le Mac. Sauf que les dernieres mises a jour de Mac OSX ont casse tout cela, et la methode ne fonctionne plus :/ Sur Mac, la solution de sauvegarde sappelle Time Machine, un systeme de backup genial, qui permet litteralement de voyager dans le temps pour restaurer un fichier efface, ou meme une version precedente de ce fichier. Pour fonctionner, Time Machine a besoin dun disque dur connecte au Mac, ou dun Time Capsule, une sorte de disque dur reseau facon Apple. Certains appareils arrivent toutefois a ruser et se faire passer pour des Time Capsules, ce qui permet de profiter de Time Machine sur un Nas par exemple (comme les NAS Synology). Meme si cela ne fonctionne plus avec WHS, il existe pourtant une methode, peut etre un peu tiree par les cheveux, mais qui fonctionne parfaitement. Je vous la presente dans ce petit guide  
 I. Pre requis  Pour faire fonctionner Time Machine avec  WHS 2011 , il faut etre clair: pour le moment cest impossible. Beaucoup se sont penches sur la question, et a part une solution logicielle coutant 750$, personne na rien trouve. Lastuce consiste donc a utiliser une machine virtuelle. Pour ceux qui ne sont pas familiers avec ce concept, il sagit de faire tourner un OS dans un autre OS, en lui faisant croire quil tourne sur une vraie machine. Dou le nom de machine virtuelle. Ici, nous allons donc faire tourner un systeme qui va se faire passer pour une Time Capsule, au sein meme de WHS. La virtualisation est beaucoup utilisee en entreprise de nos jours, mais elle est egalement accessible au grand public, et ceci pour pas un sou. Differentes solutions existent:  VirtualPC ,  VirtualBox ,  Vmware , etc Cest ce dernier que nous allons utiliser. Il est gratuit, puissant, et jai lhabitude de lutiliser au travail :p On commence donc par telecharger  Vmware Server 2 pour Windows ici . Il faudra simplement creer un compte pour senregistrer et obtenir un numero de licence. Une fois le package dinstallation telecharge, on linstalle sur le serveur WHS comme nimporte quel autre programme. Un raccourci apparaitra sur le bureau a la fin de linstallation pour lancer le tableau de bord de Vmware. Un avertissement peut apparaitre de la part dinternet explorer: pas de panique, on passe outre, Vmware est sans danger. Il ny a plus qua sidentifier a laide du nom dutilisateur et mot de passe de votre session Windows actuelle. Tant que nous en sommes au telechargement, il en reste un dernier: telechargez des maintenant la derniere image ISo de Debian en 32 bits , ce qui sera bien suffisant. Seul le premier CD sera necessaire.  
 II. Configuration de la Time Capsule On commence donc par creer une machine virtuelle dans Vmware.   On lui donne un nom et on indique ou la stocker:   Et on indique quon va installer un systeme Linux Debian en 32 bits (notre serveur ici tourne en 64 bits, mais un Linux en 32 bits sera suffisant et plus petit).   128Mo de memoire Ram seront suffisants:   Ensuite on cree un nouveau disque dur, auquel on affecte 1Go. Ce disque dur contiendra le systeme Linux, qui na pas besoin de plus:   On ajoute une connexion reseau en pont:   Puis on indique limage ISO de la distribution Debian quon a telecharge plus haut pour simuler le lecteur CD:   Pas la peine dajouter de lecteur de disquette ni de port Usb, ce sera inutile pour notre utilisation.   On valide ensuite la creation de notre machine virtuelle. Derniere chose: lajout dun second disque dur qui servira au stockage des backups de Time Machine. Notre nouvelle machine virtuelle etant selectionnee, on clique sur Add Hardware, et on choisi Hard:   On indique lespace quon souhaite allouer au stockage des sauvegardes. Ici jy consacre 300Go, par exemple:   Cest termine pour la creation de notre machine virtuelle. Il ny a plus qua installer un systeme dexploitation dessus. On allume donc la machine virtuelle, comme si nous allumions un vrai pc, pour quelle demarre sur le disque dinstallation de Linux. Pour cela, on va sur longlet console de la machine virtuelle, et on clique sur le gros bouton en forme de fleche pour lancer la machine. La premiere fois il est possible que Vmware vous demande dinstaller un plugin, quil vous faudra accepter.   Vous allez alors voir demarrer linstallation de la distribution Debian (Linux):   Choisissez Install. Dans lecran suivant selectionnez le francais:   Puis France   et enfin le clavier francais:   Ensuite entrez le nom que vous souhaitez donner a votre machine:   A la question suivante, concernant le nom de domaine, vous pouvez laisser vide. Il faut ensuite definir un mot de passe root ( = administrateur). Ici, jai par exemple mis tmroot   Et creer un utilisateur standard, qui sera utilise par Time Machine. En nom dutilisateur et en mot de passe jai mis ici  tmuser :   On va enfin pouvoir passer a linstallation sur le disque dur, en choisissant linstallation Assiste  utiliser un disque dur entier:   Puis on selectionne le disque qui fait 1Go:    On confirme et on applique ces choix:   Il ny a plus qua patienter quelques minutes que le systeme sinstalle:   A la question faut il analyser un autre disque repondez par la negative:   Et confirmez lutilisation dun miroir pour les paquets (les fichiers dinstallation seront ainsi recuperes directement sur internet, sans avoir besoin de telecharger les nombreux disques Debian):   Une derniere question vous sera posee, a propos des applications a installer des le depart: comme on cherche a faire un systeme tres leger, on ne choisira que le serveur SSH pour pouvoir se connecter a la machine a distance, et les utilitaires standarts du systeme:   Pour terminer, acceptez linstallation de Grub pour le demarrage de la machine:   Il ny a plus qua laisser redemarrer la machine:   Il faut maintenant effectuer quelques petits reglages et installer certains packages (applications). Pour se faciliter la vie, on va sy connecter via SSH. Il suffit de relever ladresse IP de la machine virtuelle donnee lors du demarrage, puis de sy connecter depuis un autre ordinateur a laide dun logiciel comme  Putty . Ce sera plus pratique de de devoir travailler dans la console de Vmware (et surtout ca vous permettra de copier / coller les lignes de commande qui vont suivre). Dans un premier temps, il va falloir preparer le second disque dur virtuel qui accueillera les sauvegardes. Les commandes a taper sont en gras pour les identifier:  fdisk /dev/sdb Command (m for help):  n Command action e extended p primary partition (1-4) p Partition number (1-4):  1 First cylinder (1-13054, default 1): Using default value 1 Last cylinder, +cylinders or +size{K,M,G} (1-13054, default 13054): Using default value 13054 Command (m for help):  w The partition table has been altered! Calling ioctl() to re-read partition table. Syncing disks.  Ensuite on formate le disque dur:  mkfs.ext4 /dev/sdb1  et on le monte pour quil soit acessible facilement:  mkdir /mnt/MyTimeCapsuleData chmod 777 /mnt/MyTimeCapsuleData/ echo /dev/sdb1 /mnt/MyTimeCapsuleData ext4 defaults 0 0  /etc/fstab mount /mnt/MyTimeCapsuleData   Nous avons besoin maintenant dinstaller Avahi, qui est un package permettant la meme chose que Bonjour sous Apple, mais en open source. Cest ce qui permettra a notre Time Capsule virtuelle detre vue par le Mac. Pour un soucis de compatibilie, il nous faut la version la plus recente, qui nest actuellement pas disponible dans les sources par defaut de la Debian. On va donc lui ajouter quelques chemins ou chercher On va editer le fichier des sources:  nano /etc/apt/sources.list  Puis ajouter ces deux lignes tout en bas du fichier:  deb http://ftp.us.debian.org/debian/ wheezy main deb-src http://ftp.us.debian.org/debian/ wheezy main  Commentez egalement la premiere ligne cdrom a laide dun # devant la ligne, ca evitera que le systeme vous reclame un CD que vous navez pas:   Faites Ctrl + O pour enregistrer, puis Ctrl + X pour quitter le fichier ensuite. On definit maintenant la source par defaut:  echo APT::Default-Release squeeze\;  /etc/apt/apt.conf  On met a jour les paquets:  apt-get update  Et on installe Avahi:  apt-get install avahi-daemon libnss-mdns  Puis Netatalk:  apt-get install netatalk libc6-dev -t wheezy   On configure Netatalk via cete commande (sur une seule ligne):  echo /mnt/MyTimeCapsuleData MyTimeCapsule allow:tmuser cnidscheme:dbd options:tm  /etc/netatalk/AppleVolumes.default  Maintenant on configure Avahi en editant son fichier de configuration:  nano /etc/nsswitch.conf  Recherchez la ligne  hosts: files mdns4_minimal [NOTFOUND=return] dns mdns4  pour y ajouter mdns a la fin:   et on cree le fichier  nano /etc/avahi/services/afpd.service  qui contiendra cela:  ?xml version=1.0 standalone=no?!*-nxml-* !DOCTYPE service-group SYSTEM avahi-service.dtd service-group name replace-wildcards=yes%h/name service type_afpovertcp._tcp/type port548/port /service service type_device-info._tcp/type port0/port txt-recordmodel=TimeCapsule/txt-record /service /service-group  Ctrl + O pour enregistrer, et Ctrl + X pour fermer le fichier.   On redemarre les services  /etc/init.d/netatalk restart /etc/init.d/avahi-daemon restart  Cest fini !  
 III. Configuration du Mac  Votre machine virtuelle est en fonctionnement ? Le plus dur est fait. Sur le Mac, rendez vous maintenant dans le panneau Systeme, puis Time Machine. Cliquez sur Choisir un disque, vous devriez voir apparaitre MyTimeCapsule, qui est donc la Time Capsule virtuelle quon vient de configurer:   Il est possible que le Mac vous demande un identifiant. Dans ce cas, tapez tmuser en nom dutilisateur et en mot de passe (ou ce que vous aurez entre lors de linstallation de la Debian). La premiere sauvegarde Time Machine devrait alors se lancer automatiquement:   La premiere fois, elle prendra un peu de temps, selon la quantite de donnees que vous avez a sauver. Nhesitez pas a vous rendre dans Options pour interdire la sauvegarde de repertoires qui vous paraissent inutiles, ce qui contribuera a reduire la taille du backup:   Chez moi la sauvegarde de 270Go a necessite pres de 6h. Mais ensuite, le backup devient totalement transparent, seuls les fichiers modifies etant sauves par la suite. Une fois les sauvegardes faites regulierement, on peut utiliser Time Machine pour restaurez nimporte quel fichier du systeme, voire meme reinstaller le systeme complet sil le faut.   
 IV. Conclusion  Je vous laccorde, ce nest pas la methode la plus simple quon ait vu. Mais elle a le merite de parfaitement fonctionner, meme avec mon OSX Mountain Lion a jour. Puis ce nest pas cette machine virtuelle, avec ses 128Mo de ram et son OS d1Go, qui va epuiser  mon serveur WHS  :p Mais au moins, ce dernier heberge vraiment toutes les sauvegardes, que ce soit PC ou Mac, et cela en toute transparence. Le systeme fonctionne chez moi deja depuis 3 semaines sans aucun soucis, et la restauration de fichiers fonctionne parfaitement. Bref, si vous cherchez une solution pour sauvegarder votre Mac sur votre serveur WHS 2011, vous savez quoi faire ! Pour ma part, je remercie  Kevin Herring qui est a la base de cette solution tres pratique , car une telle astuce, ca ne sinvente pas;-)   Le monde MAC   Time Machine   WHS 2011 
        </text>
</document>
