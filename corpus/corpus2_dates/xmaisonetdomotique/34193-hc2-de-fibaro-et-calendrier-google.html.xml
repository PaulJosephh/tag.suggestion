<document>
	<date>2013-11-22</date>
        <title>
HC2 de Fibaro et calendrier Google</title>
        <author>Cdric Locqueneux</author>
        <tags_set>
                <tag>Fibaro</tag>
                <tag>google</tag>
                <tag>hc2</tag>
                <tag>scriptsphp</tag>
        </tags_set>
        <categories_set>
                <category>Guides Box Domotique</category>
        </categories_set>
        <text>Il y a plusieurs mois je vous ai propose  un script pour utiliser votre calendrier Google  avec votre box domotique  eedomus  ou  Zibase . Script que vous pouviez utiliser en ligne depuis le site, ou heberger directement chez vous. Suite a ma migration sur le Home Center 2 de Fibaro, jai donc cherche a reproduire la meme fonction, qui mest tres utile. Pour rappel, cette fonction peut etre vraiment tres pratique pour des personnes ayant des emplois du temps tres variables, ce qui necessite de modifier la configuration de lagenda sur la box ( eedomus ) ou les scenarios ( Zibase , HC2). Cest par exemple mon cas: travaillant en informatique, il peut arriver de travailler la nuit, ou le week end, si une maintenance serveur est necessaire. Selon mes contraintes, il marrive egalement daller travailler en train (le plus courant) ou en voiture (si mes horaires le demandent): la mon heure de lever ne sera pas du tout la meme. De ce fait, il peut metre necessaire de modifier la configuration de la box 2 ou 3 fois par semaine. Comme mon emploi du temps est entierement gere sur Google (jours de conges, rendez vous, etc), lideal est que la box puisse le consulter et gerer les scenarios en consequence. Comme nous lavons vu auparavant, cest possible. Jai donc mis a jour mon petit script pour quil puisse fournir un resultat en Json et donc etre utilise plus facilement avec le HC2 de Fibaro, le xml etant un peu plus difficile a interpreter pour elle.  
 I. Pre requis  Il vous faut bien sur un agenda Google.Si vous navez pas dagenda Google, vous pouvez  en creer un gratuitement ici . Pour ma part, jai un calendrier Google reserve a mes conges. Les conges sont indiques dans lentete de la journee (un conge marque de telle heure a telle heure ne fonctionnera pas):   Note: pour eviter tout probleme, utilisez des mots simples, sans espace ni caractere accentue. Par exemple comme ici: cp, ferie, weekend, etc Pour recuperer les informations de votre calendrier, vous aurez besoin de son adresse privee. Pour cela, rendez vous dans les parametres de votre calendrier Google. Tout en bas, vous trouverez une icone XML, dans la partie adresse URL privee:   Faites un clic droit sur cette icone, et recuperez ladresse. Cette adresse est ladresse de votre calendrier, mais codee de facon a ce quelle ne soit pas publique, de ce genre: http://www.google.com/calendar/feeds/ qsnmyourtcndaoeh6mt3663ing%40group.calendar.google.com/private-1ac30ee2598467tfb4807d7096dc6 /basic Il faudra recuperer la partie en rouge ici, situee entre feeds/ et /basic. Nous pouvons maintenant passer a la configuration sur la box.  
 II. Utilisation du script  Le script que je vous met a disposition est tres simple. Il faudra appeler cette adresse:  http://maison-et-domotique.com/scripts/agenda.php  Et passer certains parametres:  ?cal= id_calendrier decode= correspondances defaut= valeur_par_defaut json= 1  id_calendrier: il sagit de ladresse du calendrier, recuperee precedemment (partie en rouge). correspondances: pour chaque mot trouve dans le calendrier, on va y affecter une valeur numerique. Par exemple 0,travail,1,cp,2,weekend,3,ferie. Si dans le calendrier le script trouve cp, il remontera 1. valeur_par_defaut: il sagit de la valeur que devra prendre le script sil ne trouve rien dans le calendrier. Pour ma part jutilise 0: en effet, je ne fais figurer dans mon calendrier que mes jours de conges, il serait idiot de devoir mentionner tous les jours de travail. Donc si le script ne trouve rien dans mon calendrier, il considere que cest 0, donc un jour de travail. json: par defaut, le script renvoi un resultat en xml. Si on le veut en json, plus simple a exploiter sur la FibaroBox, il suffit dajouter ce parametre json=1 Vous voyez le principe ? Au final, on obtient par exemple une adresse de ce type:  http://maison-et-domotique.com/scripts/agenda.php?cal=rtderfhgj_qsnmmourtcndaonh6mt3g63ing%40group.calendar.google.com/private-1ac150ee21588467d3fb4807d7096dc6decode=0,travail,1,cp,2,weekend,3,feriedefaut=0json=1  Pour verifier que tout fonctionne bien, une fois que vous aurez renseigne ladresse avec vos propres arguments, il suffit de taper ladresse web de ce fichier dans votre navigateur web.Vous devriez obtenir quelque chose de ce genre:  {aujourdhui: 0,aujourdhui_text: travail,demain: 0,demain_text: travail}  On a donc ici un fichier json parfaitement exploitable par le HC2. On y voit letat du jour, mais egalement letat du lendemain (en valeur et libelles).  
 III. Configuration de la box  On va commencer par creer 4 variables sur la box, via le menu Panneaux, puis Variables. Ce sont des variables normales, pas des variables predefinies.     Aujourdhui: contiendra la valeur du jour (0,1,2) passe en parametre de lURL vue plus haut Aujourdhui_Text: contiendra le libelle plus explicite, quon utilisera juste sur linterface pour que ce soit plus parlant idem pour Demain et Demain_Text. Les variables xx_Text sont la si on souhaite les utiliser dans autre chose, pour plus de clarte, mais elles ne sont pas obligatoires pour notre utilisation.  Maintenant nous allons creer un peripherique virtuel. La presentation pourra etre adaptee selon vos besoins. Pour ma part je lui ai mis deux labels qui contiendront letat du jour et du lendemain, puis un bouton qui lancera le script de mise a jour:   Pour les labels, cest tres simple, jai juste donne un nom pour letat du jour et du lendemain:   Cest le bouton suivant qui va etre charge de completer les labels et les variables creees plus haut:   Le script se presente de cette facon:  HC2 = Net.FHttp(maison-et-domotique.com) response = HC2:GET(/scripts/agenda.php?cal=votreadressedecalendrierdecode=0,travail,1,cp,2,weekend,3,feriedefaut=0json=1)  response = json.decode(response)  fibaro:setGlobal(Aujourdhui, response.aujourdhui) fibaro:setGlobal(Aujourdhui_Text, response.aujourdhui_text) fibaro:setGlobal(Demain, response.demain) fibaro:setGlobal(Demain_Text, response.demain_text)  fibaro:log(Aujourd hui : ..fibaro:getGlobalValue(Aujourdhui_Text).. Demain : ..fibaro:getGlobalValue(Demain_Text))  fibaro:call(89,setProperty,ui.Label1.value,response.aujourdhui_text) fibaro:call(89,setProperty,ui.Label2.value,response.demain_text)  Pour eviter les problemes de mise en page du blog, vous pouvez  telecharger le script Lua ici . Il faudra bien sur ladapter a vos besoins: adresse de votre calendrier, valeurs pour le decodage (travail = 0, etc) et nom des labels si vous les avez changes. Egalement, si vous hebergez le script php sur votre propre serveur, il faudra bien sur remplacer maison-et-domotique par ladresse de votre serveur. Une fois tout cela complete, enregistrez la configuration. A partir de la, si vous cliquez sur le bouton mise a jour du nouveau module virtuel, les etats de chaque jour vont se mettre a jour:   Les variables creees au debut seront egalement mises a jour. Derniere etape, on va creer une scene qui va se charger de lancer la recuperation des donnees. On aurait pu simplement mettre le script precedent dans le Main Loop du module, mais celui ci est lance toutes les secondes, ce qui a mon avis risque de surcharger la box pour rien. Ce nest pas judicieux de lutiliser ici. Dans mon cas, je souhaite simplement recuperer une fois par jour letat du jour et du lendemain, le script na donc besoin detre lance quune seule fois, par exemple tous les jours a 1h du matin .   On selectionne le peripherique virtuel, et on actionne son bouton, qui va declencher le script vu precedemment. Ainsi, plus rien a gerer, letat des jours va sactualiser automatiquement chaque nuit.  
 IV. Utilisation  Connaitre letat du jour, cest bien, mais en pratique a quoi cela peut il bien servir ? Un exemple concret avec louverture des volets, par exemple: quand je travaille je veux quils souvrent au lever du soleil, si je ne travaille pas ouverture a heure fixe a 9h. Pour cela je vais utiliser deux scenes. La premiere scene ouvre les volets au lever du soleil si je travaille:   Chaque jour au lever du soleil, on regarde donc si la variable Aujourdhui =0 (valeur utilisee pour le travail). Si cest le cas, on ouvre les volets (et au passage je menvoie un petit mail pour me le confirmer, le temps du rodage ;-) Attention a bien decocher le trigger Aujourdhui tout en haut au dessus de la scene, sous peine davoir vos volets qui souvrent en pleine nuit (jai teste ;-) Meme type de scene pour les jours non travailles:   Cette fois on verifie chaque jour a 9h precise si la variable Aujourdhui est  0 (0 etant un jour travaille, les autres jours feries, conges, week end ayant des valeurs superieures a 0). Si cest le cas, on ouvre les volets. La aussi, bien penser a decocher le trigger en haut. Enfin, pour les deux scenes, verifiez bien quelles soient actives et lancees au demarrage de la box:   Et voila ! Les volets vont souvrir tout seuls en fonction de votre calendrier Google. Avec du code Lua, il est sans doute possible de nutiliser quune seule scene pour gerer les differents types de jours, mais comme on debute sur le HC2, on va y aller doucement ;-) Dans le meme genre, jen utilise une autre pour me preparer la maison si je travaille:    Ici, si cest un jour travaille, alors le seche serviettes de la salle de bain se met en route a 5h30 pour avoir le temps davoir une serviette chaude, mallume la lumiere du salon et de la cuisine une demie heure apres, me laisse dejeuner, puis eteint les lumieres automatiquement Bref, on peut lutiliser pour differentes choses :D  
 V. Conlusion  Plutot simple, non ?A lutilisation cest vraiment tres pratique, puisque jutilise tous les jours mon calendrier Google: cela me permet de gerer mon emploi du temps, de le synchroniser sur mon iPhone, de le partager avec ma femme, etc Lutilite de lagenda Google nest plus a demontrer. Aujourdhui, sans rien faire de plus, ce calendrier est egalement consulte par ma box domotique Fibaro, qui gere alors la maison en consequence. Le plus utilise sera letat du jour en cours, mais letat du lendemain peut etre tres utile egalement. Chez moi, cet etatme permet de faire dautres actions: par exemple quand le lendemain est une journee travaillee, je coupe les alertes vocales de mon systeme multiroom plus tot histoire de ne pas etre derange quand on est couches. Le volet de ma porte fenetre se ferme egalement plus tard si le lendemain est une journee a la maison. Ce procede peut etre utilise pour diverses choses. Jai par exemple configure un autre calendrier pour le ramassage des poubelles, car avec les jours feries et le ramassage des dechets recyclables tous les 15 jours, je suis toujours en train de me demander quelle poubelle sortir quel jour :p Cette alerte me permet derecevoir une notification push la veille au soir, ou meme une notification via mon Karotz. On peut imaginer faire un calendrier du meme genre pour les jours decole, pour les anniversaires, un pour gerer le chauffage, etc Voila, jespere que ce petit script repondra aux besoins de chacun. Nhesitez pas a me remonter toute suggestion ou idee dutilisation ;-)   
[box_download]PS: Pour ceux qui preferent lheberger eux meme, les fichiers sont disponibles ici .[/box_download]    Fibaro   google   hc2   scriptsphp 
        </text>
</document>
