<document>
	<date>2011-12-14</date>
        <title>
Projet : Controleur de lumire de scne</title>
        <author>Daniel Callerand</author>
        <tags_set>
                <tag>Arduino</tag>
                <tag>Velleman</tag>
        </tags_set>
        <categories_set>
                <category>Guides Eclairage</category>
        </categories_set>
        <text>Vincent vous avait presente il y a quelques temps  la carte Velleman , une carte relai a monter soi meme pour une cinquantaine deuros. Je vais vous presenter aujourdhui comment jai utilise cette carte Velleman, couplee a une carte Arduino et un clavier PS2 pour controler un eclairage de scene.  
 I. Presentation  Le module declairage peut commuter 8 prises secteur a partir dun clavier PS2 deporte jusqua 20m (teste, on peut probablement aller plus loin en boostant le signal). Il ny a pas de PC, la gestion du clavier PS2 est realisee par une carte Arduino, rendant lensemble autonome. Seul le bloc de prises contenant la carte relais (sur scene) a besoin detre alimente. La carte Arduino et le clavier (vers la console) sont alimentes par la carte Velleman qui dispose dune sortie 12 volt regulee, envoyee dans un cable RJ45. Ce meme cable transporte le signale RS232 de lArduino vers la carte Velleman. Le 12V est abaisse en 5V.   La carte Velleman etant tres lente a reagir, elle a ete modifiee pour etre plus nerveuse. Son PIC 16F630 a ete remplace par un 16F84A avec un bout de code gerant la liaison RS232 a 9600bauds au lieu des 2400 dorigine et le protocole a ete reduit au strict minimum.   On peut pousser la liaison a 19200 bauds mais il y a quelques erreurs avec 20M de cable. Cela etant la reactivite est excellente a 9600. La vitesse de transmission de linfo utile est en theorie multipliee par 16 entre les deux versions. 
La platine Velleman a trouve sa place dans lancienne carcasse dun demodulateur satellite obsolete. Au passage on a garde le transfo pour alimenter la carte.   Une caisse en plastique avec couvercle denviron 30 x 30 x 40cm fait office de multiprise / caisson. Le fond a ete double dune plaque de bois de 20mm  
 II. Developpement  Vous trouverez toutes les sources dans cette archive . Cette archive contient les elements suivant : PIC16F84 : Schema, typon et code source ASM de la modification de la carte velleman. Arduino : Sketch arduino de gestion du clavier PS2 et envoi des ordres a la carte Typon et schema de ladaptateur de tension 12V-5V Classe reutilisable pour le controle dune carte velleman K8056 non modifiee Arduino : Sketch principale de gestion des touches recues et denvoi des ordres a la carte Classe Velleman modifiee utilisee dans le sketch principal Classe Velleman pour une carte avec son pic dorigine (non utilise dans le sketch fournit mais les fonctionnalites sont identiques a lexceptions des memoires et de la fonction running Classe PS2Keyboard sous licence FSF (dispo sur arduino.cc) RS32adapter  Regulateur 5V : Deux schemas et leur typons. Lun pour booster le signal issu darduino vers un niveau RS232 standard (idealement un circuit max232 fait laffaire, mais je navais que quelques transistors sous la main, de plus dans la version modifiee de la carte, cette interface semble inutile, ce que je ne mexplique pas) Lautre pour abaisser le 12V en 9V pour alimenter arduino 
 III. Fonctionnement  Tout le controle se fait donc via le clavier PS2. Fonctions au clavier : Les touches 1 2 3 4 5 6 7 8 se comportent en interrupteurs Toggle pour les relais 1 a 8 La ligne en dessous a z e r t y u i correspond a la fonction On pour les relais 1 a 8 La ligne en dessous q s d f g h j k correspond a la fonction Off pour les relais 1 a 8 La ligne en dessous en majuscules W X C V B N ? . correspond a la fonction Memoires pour 8 patterns memorisant letat en cours dans une pattern La meme ligne en minuscule w x c v b n , ; rappelle ces patterns La touche Entree met la carte en mode running, elle enchaine alors les patterns memorises avec un delai qui sincremente ou se decremente en appuyant sur les touches + et -. Petite demonstration en video, ce qui sera beaucoup plus parlant:  Pas mal, non ?  
 IV.Evolutions  Des evolutions auront probablement lieu: Gestion delai Lumieres clavier Integration arduino directement dans clavier Protocole A suivre ! Jespere que ce montage vous donnera deja quelques idees   Arduino   Velleman 
        </text>
</document>
