<document>
	<date>2013-04-19</date>
        <title>
Test du RazBerry avec le logiciel Z-Cloud</title>
        <author>Cdric Locqueneux</author>
        <tags_set>
                <tag>Raspberry</tag>
                <tag>RaZberry</tag>
                <tag>Z-wave</tag>
                <tag>Z-Wave.me</tag>
                <tag>ZWay</tag>
        </tags_set>
        <categories_set>
                <category>Domotique</category>
        </categories_set>
        <text>Nous avons vu il y a quelques jours quil etait possible de  se faire une petite box domotique a pas cher avec un Raspberry et la carte fille RaZberry , qui lui ajoute donc le controle dun reseau Z-Wave. Le logiciel Zway, quon peut utiliser sur la RaZberry en local, est sympa, malheureusement il manque toute la partie scenarios. Cette partie est disponible sur une autre version, ZCloud, qui comme son nom lindique est hebergee dans le cloud, donc sur des serveurs exterieurs.   Nous allons voir aujourdhui comment installer cette version sur notre RaZberry, car celle ci est un peu plus compliquee que pour ZWay, qui etait enfantine  
 I. Installation  Avant toute chose, il vous faut bien entendu un Raspberry Pi avec la carte fille RaZberry, et une carte SD avec le systeme Rasbian installe dessus. Ensuite, on se connecte en ssh au Raspberry, avec un logiciel comme  Putty  par exemple sous Windows (ou la commande ssh directement dans le terminal sur Mac).Pour rappel, si vous ne les avez pas modifies, le nom dutilisateur par defaut est  pi  et le mot de passe  raspberry . On commence par installer les librairies necessaires avec la commande :  sudo apt-get install libargtable2-0 libargtable2-dev   Ensuite, il va falloir creer des repertoires. On cree dabord le repertoire zagent (commande mkdir), ensuite on entre dedans (commande cd), et on cree le repertoire Certificates:   On reste dans le repertoire zagent puis on telecharge ensuite les scripts necessaires a ZCloud en tapant:  wgetwget https://z-cloud.googlecode.com/git/Z-Connector/Unix/Run_Z-Agent.sh wgethttps://z-cloud.googlecode.com/git/Z-Connector/Unix/Release/Raspberry/z-agent   On donne ensuite les droits necessaires a ces scripts en tapant:  chmod u+x *  Maintenant on verifie le port attribue a la carte fille avec la commande dmesg|grep tty:   Il faut ensuite editer le fichier Run_Z-Agent.sh pour indiquer le port de la carte obtenu precedemment, ici ttyAMA0 (quon peut voir a la derniere ligne de la capture ci dessus):  nano Run_Z-Agent.sh   Renseignez le bon numero de port dans le fichier (encadre ici en rouge), puis faites Ctrl+O pour enregistrer puis Ctrl+X pour sortir. Telechargez ensuite les certificats sur le site  Z-Wave.Me . Il vous faut dabord creer un compte (procedure classique). Une fois cela fait, et loggue a votre compte, vous apercevrez sur la gauche ce menu:   Cliquez sur Download your Z-Connector certificates pour telecharger les certificats necessaires au fonctionnement de ZCloud. Cest ce qui permettra deffectuer une connexion securisee entre votre Raspberry et Z-Wave.me. On transfere ensuite ces certificats par SFTP, avec un client comme  Filezilla , par exemple. Ces fichiers doivent etre places dans le repertoire Certificates cree plus haut:   Il ne reste plus qua lancer lapplication par la commande  ./Run_Z-Agent.sh   Linstallation est terminee ! Ce nest pas tres difficile quand on a les commandes et la marche a suivre, mais il faut avouer que ce nest pas le plus evident pour le neophyte :/ Enfin, le plus dur est passe, voyons voir maintenant lutilisation.  
 II. Utilisation  Pour se connecter a linterface, on passe donc par le site  Z-Wave.Me . Sur la gauche, vous verrez Your status in Z-Cloud, normalement affiche en vert pour confirmer que votre Raspberry communique bien avec le cloud:   Cliquez dessus, et renseignez le nom dutilisateur et le mot de passe que vous avez choisi a la creation de votre compte. Une alerte de votre navigateur peut vous signaler que le certificat nest pas signe. Passez outre la mise en garde, vous pouvez y aller sans soucis ;-) Vous arriverez alors sur le meme type de presentation que Zway, avec un plan de maison pre installe:   Je ne vais pas re expliquer ici comment ajouter des modules Z-Wave, creer le plan de sa maison et les placer dessus. Linterface est identique a  Zway que nous avons vu ici , je vous conseille donc de revoir cet article. Chez moi, une fois les modules inclus et le plan personnalise, voici un exemple de ce que ca donne (cest un plan bidon recupere sur internet pour la demo ;-)   La partie qui nous interesse le plus ici est la partie regles et scenarios, inexistante sur ZWay. Cest donc cette partie que nous allons voir plus en detail aujourdhui.   
 1. Les scenes  Il est possible de creer des scenes, qui sont une sorte de scenario mais vraiment basique. Le but est de declencher une serie dactions avec un seul bouton. Par exemple une scene depart, qui va fermer les volets, eteindre les lampes, et activer lalarme. Par defaut quelques scenes predefinies existent, notamment pour gerer le reseau Z-Wave:   Une barre de boutons en bas de lecran permet de creer une scene, en cliquant sur New. On peut alors donner un nom a la scene, et choisir une couleur pour lidentifier plus facilement:   En cliquant sur licone tout a droite, on peut choisir via le menu Append After et Device Change dajouter un premier peripherique:   On choisit alors le peripherique quon souhaite, et letat dans lequel on veut le passer. Ici par exemple je veux eteindre le plafonnier de mon salon (donc commande set et valeur Off):   On peut ainsi ajouter autant de peripheriques quon le souhaite dans une meme scene. Une fois finie, il suffit de cliquer sur Save en bas de lecran pour lenregistrer. Pour lexecuter, on passe par le plan, clic droit sur la piece concernee, et Scenes:   
 2. Les regles (rules)  Les scenes sont le point de depart des scenarios, car cest par elles que se feront les actions. En effet, dans une regle, la seule action possible est de lancer une scene, immediatement ou avec un certain delai. En revanche, au niveau des declenchements, de nombreuses possibilites sont possibles. On peut ainsi utiliser plusieurs conditions, avec des ET ou des OU:   Pour creer une regle, cest tres simple: bouton New en bas de lecran, puis on donne un nom a la regle. Ensuite, avec un clic droit on peut ajouter une operation logique (et/ou), verifier si une scene est lancee, ou verifier un evenement sur par exemple un capteur:   A noter que dans les conditions, il est egalement possible dutiliser un script python, ce qui rend le systeme tres tres puissant. Pour cela, il suffit de cliquer sur le mode expert, disponible en bas a droite. Une nouvelle option Evaluate python script apparait alors dans les options de declenchement:   On peut alors saisir le script quon souhaite:   Je vous conseille de jeter un oeil aux scenarios crees par defaut, qui donnent deja un bon apercu de ce quil est possible de faire. Une fois levenement ajoute, toujours a laide du clic droit, on choisit les parametres a verifier:   On peut ensuite choisir les actions a effectuer:   On peut alors lancer une scene, immediatement ou apres un certain delai. Une fois la regle creee, il faut bien penser a lenregistrer via le bouton Save en bas de lecran.  
 3. Les programmations (schedules)  Les programmations permettent de lancer une scene a un moment donne (une heure precise ou meme a un intervalle regulier). Le principe est semblable aux taches cron quaffectionnent beaucoup les linuxiens ;-) Un exemple pour lancer une scene toutes les 10min:   Ou encore tous les vendredis a minuit:   Le principe est le meme que pour les regles: clic droit, et on selectionne le critere pour le lancement:   Puis ensuite la scene a lancer, immediatement ou avec un delai. Note: il existe un autre menu, Climate Schedule, destine a gerer un chauffage. Je nai par contre pas pu tester cette partie, netant pas equipe de thermostats.  
 4. Letat des zones  Ici, nous avons un apercu direct de chaque piece (zone) et de letat dans laquelle elle se trouve. Le salon peut par exemple etre en mode Cinema, le garage en mode Alarme, etc On le voit directement dans cette vue, et il est possible de modifier letat rapidement en selectionnant la scene quon souhaite pour telle ou telle piece. Tout a droite, il est egalement possible de gerer le chauffage ou la climatisation pour chaque piece. Tres pratique !   
 III. Conclusion  Lajout de la partie automatisation dans Z-Cloud, via les scenes, les regles, et les programmations, permet davoir avec sa RaZberry une vraie box domotique, qui pourrait etre comparee a une  Vera , une  Zipabox , ou autre box du meme type. Il faut avouer que la partie regles peut etre tres puissante, notamment avec lutilisation de scripts. Mais javoue que la solution me laisse indecis, notamment pour deux raisons: tout dabord, le passage oblige par le cloud. Il aurait ete preferable dajouter cette partie a ZWay, pour avoir une solution autonome sur son Raspberry. Je trouve vraiment dommage de devoir passer par des serveurs exterieurs pour cela, surtout quon y perd en reactivite: quand on lance une action cela passe par les serveurs Z-Wave.me pour ensuite arriver sur notre Raspberry, qui va lancer laction demandee. La version ZWay, locale, sur ce point la etait vraiment tres reactive. Sans compter le risque de panne ou de problemes de connexions aux serveurs distants, qui entrainent alors limpossibilite dacceder a son systeme. Mais rassurons nous, la partie automatisation devrait a terme arriver sur ZWay, ce qui sera un excellent point le second point concerne lintuitivite des regles. Certes, ces regles peuvent etre tres puissantes, mais il faudra regarder les exemples existants et faire des essais avant de bien comprendre le fonctionnement et realiser des regles qui repondent reellement au besoin. Un  forum officiel  existe, ou on peut trouver un peu daide, mais les ressources sont encore peu nombreuses, la solution etant toute recente. La solution telle quelle, donc, pour sa mise en place et son utilisation, sadressera plutot a des utilisateurs avances, je pense. Dommage, car la partie pilotage de la maison via le plan etait vraiment tres attirante et facile a utiliser. Heureusement, cette solution a base de Raspberry etant tres ouverte, dautres distributions logicielles, peut etre mieux adaptees aux debutants, sont egalement disponibles.  Domadoo en a dailleurs dresse une liste tres interessante  il y a quelques jours. Il ny a plus qua aller tester ces autres solutions. Dailleurs, je vous parlerai de lune delle dans les prochains jours :p   Raspberry   RaZberry   Z-wave   Z-Wave.me   ZWay 
        </text>
</document>
