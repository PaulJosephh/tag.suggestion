<document>
	<date>2014-05-23</date>
        <title>Domoticz : utilisation de FHEM comme passerelle EnOcean</title>
        <author> Laurent </author>
        <tags_set>
                <tag>domoticz</tag>
                <tag>domotique</tag>
                <tag>enocean</tag>
                <tag>fhem</tag>
                <tag>logiciel</tag>
                <tag>open source</tag>
                <tag>passerelle</tag>
                <tag>Raspberry Pi</tag>
        </tags_set>
        <categories_set>
                <category>Domotique</category>
        </categories_set>
        <text>
                                                         Au cours des deux articles precedents, nous avons pu decouvrir la solution opensource  Domoticz domotique Raspberry Pi Z-Wave Autre technologie  radio domotique EnOcean sans-fils sans piles Cec EnOcean EnOcean Domoticz EnOcean 1. Materiel requis Les peripheriques  EnOcean   Un interrupteur double  Vimar Un capteur de temperature et dhumidite  Trio2Sys Un capteur de contact de fenetre  Trio2Sys On remarque sur les capteurs la petite cellule photovoltaique qui fourni lenergie necessaire a leur fonctionnement. Equipes dun petit accumulateur interne, ils peuvent tenir jusqua 4 jours en pleine obscurite. Linterrupteur quand a lui est alimente directement par lenergie liberee lors de lappui sur les touches, par effet piezo-electrique. Pour que le Raspberry Pi puisse communiquer avec des peripheriques  EnOcean EnOcean USB300 USB TCM310 ESP3 EnOcean On connectera donc ce dongle sur un des ports disponibles du HUB  USB Attention, ne connectez pas pour linstant votre eventuel  RFXCom Si lon a bien suivi la  procedure decrite dans le precedent article permettant de definir un alias persistant a nos peripheriques USB USB /dev/ttyUSB12 Notre  Raspberry Pi EnOcean Domoticz 2. Presentation de FHEM Cette fois ci helas, lequipe de  Domoticz Domoticz EnOcean ESP2 TCM-120.    USB Configuration/Materiel Qua cela ne tienne, nous allons nous baser sur un autre logiciel opensource sous licence GPL, nomme  FHEM FHEM Domotique FHEM Domoticz Ce qui nous interesse ici tout particulierement, est que  FHEM USB   EnOcean FHEM EnOcean Domoticz http FHEM passerelle EnOcean Domoticz Domoticz Domoticz  de faire abstraction des differences existant entre les differents protocoles utilises (ici, RF433,  Z-Wave EnOcean NB: On trouvera tous les details necessaires concernant le projet  FHEM homepage Encore une fois, il va falloir passer par quelques lignes de commandes. Apres setre connecte en  SSH FHEM sudo apt-get install perl libdevice-serialport-perl libio-socket-ssl-perl libwww-perl sudo apt-get install f wget  http://fhem.de/fhem-5.5.deb sudo dpkg i  fhem Pour tester si linstallation de  FHEM http  du raspberry:8083 Si tout sest bien passe, vous arrivez sur la page principale de FHEM: 3. Configuration de FHEM: FHEM detection automatique USB Cest pour cela que nous vous avons conseille au debut de larticle de ne connecter au Raspberry Pi que USB que EnOcean Il suffit donc dappuyer sur une des touches de notre interrupteur  VIMAR Trio2Sys LRN FHEM automatiquement Pour acceder au fichier general de configuration, cliquer sur  Edit files  fhem.cfg On pourra verifier que les differents peripheriques  EnOcean USB USB cec Noubliez pas de sauvegarder votre configuration en cliquant sur le bouton  Save fhem.cfg FHEM shutdown restart 4. Verification de la configuration : Le menu  EventMonitor EnOcean La detection automatique etant desormais desactivee, on pourra alors rebrancher nos eventuels dongle  RFXCom ZStickV2  FHEM 5. Utiliser FHEM en tant que passerelle FHEM est maintenant capable de recevoir differents evenements en provenance de nos peripheriques  EnOcean http http://www.domoticz.com/wiki/Domoticz_API/JSON_URL%27s Pour nous simplifier la tache, nous utiliserons des petits shells utilitaires qui effectuent les differentes requetes  http curl Exemple 1 : commande des interrupteurs Domoticz: Pour commander nos interrupteurs Domoticz, on va creer un fichier nomme switchlight .sh curl -s  http Ne pas oublier de rendre ce fichier executable: chmod +x switchlight.sh On voit que ce shell doit etre appele avec deux arguments: le premier correspond a  lIDX On Off On pourra tester ce shell manuellement : ./switchlight.sh 8 On pour activer linterrupteur Domoticz dIDX 8. En resume: Note: Pour retrouver les IDX des interrupteurs Domoticz, utilisez le menu  Configuration/Peripheriques Revenons maintenant sur linterface Web de configuration de FHEM. Nous allons ajouter dans le fichier de configuration principal les lignes suivantes, qui permettent dindiquer a FHEM quelles commandes effectuer lors de lappui de tel ou tel bouton de notre interrupteur  VIMAR ### Sur appui bouton A0 du  VIMAR define BtnA0 notify EnO_switch_008AC1AA:A0 /home/pi/switchlight.sh 8 On ### Sur appui bouton AI du  VIMAR define BtnAI notify EnO_switch_008AC1AA:AI /home/pi/switchlight.sh 8 Off Sauvegardez, et  cest pret! Vous pouvez desormais piloter vos peripheriques Domoticz grace a votre interrupteur  EnOcean Z-Wave Exemple 2 : commande des scenes et groupes Domoticz: Sur le meme principe, vous pouvez piloter vos differentes scenes ou groupesdefinis dans Domoticz : Creer un fichier /pi/domoticz/switchscene.sh, qui contiendra curl -s  http://localhost:8080/json.htm?type=commandparam=switchsceneidx=$1switchcmd=$2 Note : Pour retrouver les ID des differentes scenes et groups que vous avez cree, utiliser la commande : curl -s  http En resume: Configuration dans fhem.cfg: ### Sur appui bouton B0 du  VIMAR define BtnB0 notify EnO_switch_008AC1AA:B0 /home/pi/switchscene.sh 1 On ### Sur appui bouton BI du  VIMAR define BtnBI notify EnO_switch_008AC1AA:BI /home/pi/switchscene.sh 2 On Exemple 3: remontee de valeurs de capteurs  EnOcean Si lon desire remonter les informations de nos capteurs  EnOcean Creer le shell /home/pi/udevice.sh qui contiendra curl -s  http Dans fhem.cfg : ### On utilise les infos du capteur temp/hum pour maj le capteur dIDX 33 define TempHum notify EnO_sensor_0088F241.* { my $temp = ReadingsVal(EnO_sensor_0088F241, temperature, );; my $hum= ReadingsVal(EnO_sensor_0088F241, humidity, );; system(/home/pi/udevice.sh 33 $temp $hum) } Mises cote a cote, voici les courbes de temperatures de nos capteur RF433  Oregon Scientific   Trio2Sys Rien a dire, cest precis! On remarquera juste une frequence de mise a jour moins importante pour le capteur  EnOcean Note: Les differents shells et le fichier de configuration principal de FHEM utilises dans cette presentation sont disponibles  ici 6. Conclusion FHEM, bien quun peu austere, savere etre une solution tres efficace pour pallier au manque actuel du support natif du dongle  USB EnOcean KNX Cela aura ete une excellente opportunite pour decouvrir et exploiter linterface JSON de Domoticz qui permet denvisager dautres formes de controle. La technologie  EnOcean Mais le plus interessant, est quarrives a ce point, quel que soient les peripheriques utilises, le trio Raspberry/Domoticz/FHEM rempli a merveille son role de plateforme  domotique A vous dessayer! PS : Bravo et encoremerci a Jean-Bruno, pour cet article.  Simple Share Buttons Adder (5.6) simplesharebuttons.com  
 Ces sujets pourraient vous interesser aussi: Aucune proposition. END .entry-content  
        </text>
</document>
